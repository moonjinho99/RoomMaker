<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper

  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"

  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.rm.mapper.RoomMapper">


<insert id="makeRoom">

	insert into room(type,id) values(#{type},#{id})
</insert>

<select id="findRoomCode" resultType="int">
	select max(roomcode) from room
</select>

<insert id="makeRoomDetail">
	insert into roomdetail values(#{roomcode},#{title}, #{roompw}, #{member_cnt}, #{explanation}, #{join_member_cnt}) 
</insert>


<!-- 이미지 등록 -->
	<insert id="imageEnroll">
	
		insert into room_image(roomcode, fileName, uploadPath, uuid) values (#{roomcode}, #{fileName}, #{uploadPath}, #{uuid})
	
	</insert>
	
	<!-- 방 목록 -->
	<select id="getRoomList" resultType="com.rm.model.RoomVO">
		select r1.roomcode,type,id,title,roompw,member_cnt,join_member_cnt,explanation,fileName,uploadPath,uuid from (room r1 join roomdetail r2 on r1.roomcode = r2.roomcode) join room_image r3 on r1.roomcode = r3.roomcode order by roomcode desc
	</select>
	
	<!-- 방 조회  -->
	<select id="getRoomDetail" resultType="com.rm.model.RoomVO">
				select r1.roomcode,type,id,title,roompw,member_cnt,join_member_cnt,explanation,fileName,uploadPath,uuid from (room r1 join roomdetail r2 on r1.roomcode = r2.roomcode) join room_image r3 on r1.roomcode = r3.roomcode where r1.roomcode = #{roomcode} 
	</select>
	
	<!-- 방 갯수 출력 -->
	<select id="countRoom" resultType="int">
		select count(*) from room
	</select>
	
	<!-- 페이징 처리 후 방 조회 -->
	<select id="selectRoom" resultType = "com.rm.model.RoomVO">
		
		SELECT *
		FROM (
		    SELECT 
		        ROW_NUMBER() OVER (ORDER BY roomcode DESC) AS rn,
		        r1.roomcode,
		        type,
		        id,
		        title,
		        roompw,
		        member_cnt,
		        join_member_cnt,
		        explanation,
		        fileName,
		        uploadPath,
		        uuid
		    FROM room r1
		    JOIN roomdetail r2 ON r1.roomcode = r2.roomcode
		    JOIN room_image r3 ON r1.roomcode = r3.roomcode
		    ORDER BY roomcode DESC
		) AS b
		WHERE rn BETWEEN #{start} AND #{end};
		
	</select>
</mapper>